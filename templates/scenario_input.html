{# templates/scenario_input.html #}
{% extends "base.html" %}

{% block title %}Create Scenario | Project Horizon{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-xl-7">

      <div class="mb-5 text-center text-md-start">
        <div class="tech-kicker mb-2">SYSTEM PROTOCOL: PH-PRTCL-01</div>
        <h1 class="display-5 fw-bold text-white mb-2">Create a Scenario</h1>
        <p class="text-white fs-5">
          Configure variables for your 5-step labor automation simulation.
        </p>
      </div>

      <div class="scenario-card p-4 p-md-5">
        <form id="genForm">
          <div class="row g-4">

            <div class="col-12">
              <label for="job_title" class="form-label text-light fw-semibold">Job being replaced</label>
              <input type="text" class="form-control scenario-input" id="job_title"
                     placeholder="e.g., Taxi driver, Nurse, Teacher" required>
            </div>

            <div class="col-12">
              <label for="replacement_level" class="form-label text-light fw-semibold">Automation Depth</label>
              <select class="form-select scenario-input" id="replacement_level">
                <option value="assist" selected>AI assists humans</option>
                <option value="partial">Partial replacement</option>
                <option value="full">Full replacement</option>
              </select>
            </div>

            <div class="col-12">
              <label for="field" class="form-label text-light fw-semibold">Field / Industry</label>
              <select class="form-select scenario-input" id="field">
                <option value="general" selected>General / Society</option>
                <option value="science">Science / Research</option>
                <option value="art">Art / Creative work</option>
                <option value="business">Business / Industry</option>
                <option value="health">Health / Medicine</option>
                <option value="education">Education</option>
                <option value="environment">Environment</option>
                <option value="transport">Transport</option>
                <option value="law">Law / Policy</option>
              </select>
            </div>

            <div class="col-12">
              <label for="region" class="form-label text-light fw-semibold">Region / Context</label>
              <input type="text" class="form-control scenario-input" id="region"
                     placeholder="e.g., Seoul, South Korea">
            </div>

            <div class="col-12">
              <label class="form-label text-light fw-semibold">Stakeholders (optional)</label>
              <div class="d-flex flex-wrap gap-2 mt-2" id="stakeChips">
                <label class="chip-label">
                  <input type="checkbox" value="workers" class="d-none">
                  <span class="chip-box">Workers</span>
                </label>
                <label class="chip-label">
                  <input type="checkbox" value="consumers" class="d-none">
                  <span class="chip-box">Consumers</span>
                </label>
                <label class="chip-label">
                  <input type="checkbox" value="students" class="d-none">
                  <span class="chip-box">Students</span>
                </label>
                <label class="chip-label">
                  <input type="checkbox" value="patients" class="d-none">
                  <span class="chip-box">Patients</span>
                </label>
                <label class="chip-label">
                  <input type="checkbox" value="government" class="d-none">
                  <span class="chip-box">Government</span>
                </label>
                <label class="chip-label">
                  <input type="checkbox" value="small_business" class="d-none">
                  <span class="chip-box">Small business</span>
                </label>
              </div>
              <div class="text-muted-alt small mt-2">
                Tip: pick 1–3 to get concise viewpoint summaries during each step.
              </div>
            </div>

            <div class="col-12">
              <div class="toggle-card d-flex align-items-center justify-content-between">
                <div>
                  <div id="imageToggleLabel" class="fw-bold text-white mb-1">Visual Synthesis: OFF</div>
                  <div class="small text-muted-alt">Generate AI images for each simulation step.</div>
                </div>
                <div class="form-check form-switch custom-switch">
                  <input class="form-check-input" type="checkbox" id="enable_images">
                </div>
              </div>
            </div>

          </div>

          <div class="mt-5">
            <button class="btn btn-primary-tech w-100 py-3" id="genBtn" type="submit">
              INITIALIZE SIMULATION
            </button>
            <div id="msg" class="text-danger mt-3 text-center fw-bold"></div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- =========================
     Generation Overlay (self-contained)
     ========================= -->
<div id="overlay" class="gen-overlay" aria-hidden="true">
  <div class="gen-overlay__backdrop"></div>
  <div class="gen-overlay__card" role="dialog" aria-modal="true" aria-label="Generating scenario">
    <div class="d-flex align-items-center justify-content-between gap-3">
      <div>
        <div class="overlay-kicker">PROJECT HORIZON</div>
        <div id="overlayTitle" class="overlay-title">Generating your 5-step simulation…</div>
        <div id="overlayMsg" class="overlay-sub text-muted-alt">Building scenarios and options.</div>
      </div>
      <div class="spinner-border text-info" role="status" aria-hidden="true"></div>
    </div>

    <div class="overlay-steps mt-4" id="overlaySteps" aria-label="generation steps">
      {% for n in range(1,6) %}
      <div class="step-row{% if n == 1 %} active{% endif %}" data-step="{{ n }}">
        <div class="step-dot"></div>
        <div class="step-text">Step {{ n }}</div>
        <div class="badge-mini">In progress</div>
      </div>
      {% endfor %}
    </div>

    <div class="overlay-hint text-muted-alt mt-3">
      Please do not refresh the page while generation is running.
    </div>
  </div>
</div>

<style>
  :root {
    --bg-dark: #0b0e14;
    --card-bg: #161b22;
    --cyan: #00e7ff;
    --text-muted-alt: #94a3b8;
  }

  body { background-color: var(--bg-dark); color: #e2e8f0; font-family: system-ui, sans-serif; }

  .tech-kicker{
    letter-spacing: 3px;
    font-weight: 800;
    color: rgba(0,231,255,.85);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: .82rem;
  }

  .scenario-card { background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; }

  .scenario-input {
    background: #0d1117 !important;
    border: 1.5px solid #30363d !important;
    color: #fff !important;
    padding: 0.9rem 1rem;
  }
  .scenario-input:focus {
    border-color: var(--cyan) !important;
    box-shadow: 0 0 0 3px rgba(0, 231, 255, 0.1) !important;
  }

  .btn-primary-tech { background: var(--cyan); color: #000; font-weight: 800; border: none; }
  .btn-primary-tech:hover { background: #fff; color: #000; }

  .chip-box{
    display:inline-block;
    padding: .6rem 1.2rem;
    background:#0d1117;
    border:1.5px solid #30363d;
    border-radius:50px;
    color: var(--text-muted-alt);
    cursor:pointer;
    transition: .2s;
    user-select:none;
  }
  .chip-label input:checked + .chip-box{
    background: rgba(0,231,255,0.10);
    border-color: var(--cyan);
    color: var(--cyan);
  }

  .toggle-card{
    border: 1.5px solid #30363d;
    border-radius: 14px;
    padding: 14px 16px;
    background: #0d1117;
  }

  .custom-switch .form-check-input{
    width: 3rem;
    height: 1.5rem;
    cursor: pointer;
    background-color: #30363d;
    border-color: #30363d;
  }
  .custom-switch .form-check-input:checked{
    background-color: var(--cyan);
    border-color: var(--cyan);
  }

  /* -------------------------
     Overlay
     ------------------------- */
  .gen-overlay{
    position: fixed;
    inset: 0;
    z-index: 3000;
    display: none;
  }
  .gen-overlay.show{ display:block; }
  .gen-overlay__backdrop{
    position:absolute; inset:0;
    background: rgba(0,0,0,.65);
    backdrop-filter: blur(8px);
  }
  .gen-overlay__card{
    position:absolute;
    left:50%;
    top:50%;
    transform: translate(-50%,-50%);
    width: min(560px, calc(100vw - 32px));
    background: rgba(13,17,23,.92);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,.55);
    padding: 18px 18px 16px;
  }
  .overlay-kicker{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    letter-spacing: 3px;
    color: rgba(0,231,255,.85);
    font-size: .75rem;
  }
  .overlay-title{
    font-weight: 900;
    color: #fff;
    font-size: 1.15rem;
    margin-top: 4px;
  }
  .overlay-sub{ margin-top: 4px; }

  .overlay-steps{
    display: grid;
    gap: 10px;
  }
  .step-row{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }
  .step-row.active{
    border-color: rgba(0,231,255,.55);
    background: rgba(0,231,255,.08);
  }
  .step-row.done{
    opacity: .78;
  }
  .step-dot{
    width: 10px; height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.20);
  }
  .step-row.active .step-dot{ background: rgba(0,231,255,.95); }
  .step-row.done .step-dot{ background: rgba(0,231,255,.45); }
  .step-text{
    flex:1;
    color: rgba(255,255,255,.92);
    font-weight: 700;
  }
  .badge-mini{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: .72rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 5px 8px;
    border-radius: 999px;
    border: 1px solid rgba(0,231,255,.25);
    color: rgba(0,231,255,.95);
    background: rgba(0,231,255,.06);
    white-space:nowrap;
  }
  .overlay-hint{ font-size: .92rem; }
  .text-muted-alt{ color: var(--text-muted-alt); }
</style>
{% endblock %}

{% block scripts %}
<script>
  // -------------------------
  // Stakeholder chip toggle
  // -------------------------
  document.querySelectorAll('#stakeChips .chip-label').forEach(chip => {
    const input = chip.querySelector('input');
    const box = chip.querySelector('.chip-box');
    if(!input || !box) return;

    // allow clicking anywhere on chip
    box.addEventListener('click', () => {
      input.checked = !input.checked;
      input.dispatchEvent(new Event('change'));
    });
  });

  // -------------------------
  // Visuals toggle label
  // -------------------------
  const imgToggle = document.getElementById('enable_images');
  const imgLabel  = document.getElementById('imageToggleLabel');

  function syncImageLabel(){
    if(!imgToggle || !imgLabel) return;
    imgLabel.textContent = imgToggle.checked ? "Visual Synthesis: ON" : "Visual Synthesis: OFF";
  }
  syncImageLabel();
  imgToggle?.addEventListener('change', syncImageLabel);

  // -------------------------
  // Overlay refs (FIXED)
  // -------------------------
  const overlay = document.getElementById('overlay');
  const overlayMsg = document.getElementById('overlayMsg');
  const overlayTitle = document.getElementById('overlayTitle');
  const genBtn = document.getElementById('genBtn');

  function setOverlayStep(n){
    const rows = document.querySelectorAll('#overlaySteps .step-row');
    if(!rows.length) return;

    rows.forEach(row => {
      const step = Number(row.dataset.step);
      const badge = row.querySelector('.badge-mini');

      row.classList.remove('active','done');

      if(step < n){
        row.classList.add('done');
        if(badge) badge.textContent = "Done";
      }else if(step === n){
        row.classList.add('active');
        if(badge) badge.textContent = "In progress";
      }else{
        if(badge) badge.textContent = "Queued";
      }
    });
  }

  function showOverlay(){
    if(!overlay) return;
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
    if(overlayTitle) overlayTitle.textContent = "Generating your 5-step simulation…";
    if(overlayMsg) overlayMsg.textContent = "Building scenarios and options.";
    setOverlayStep(1);
  }

  function hideOverlay(){
    if(!overlay) return;
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
  }

  // Fake progress animation (purely visual)
  let timer = null;

  function startFakeProgress(){
    let step = 1;
    stopFakeProgress();
    timer = setInterval(() => {
      step = Math.min(5, step + 1);
      setOverlayStep(step);
      if(overlayMsg){
        overlayMsg.textContent =
          step < 5
            ? `Refining step ${step} and generating choices.`
            : "Finishing and saving to your session.";
      }
      if(step === 5){
        stopFakeProgress();
      }
    }, 550);
  }

  function stopFakeProgress(){
    if(timer){
      clearInterval(timer);
      timer = null;
    }
  }

  // -------------------------
  // Form submit
  // -------------------------
  document.getElementById('genForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const msg = document.getElementById('msg');
    if(msg) msg.textContent = "";

    const stakeholders = Array.from(
      document.querySelectorAll('#stakeChips input:checked')
    ).map(x => x.value);

    const payload = {
      job_title: document.getElementById('job_title')?.value.trim(),
      region: document.getElementById('region')?.value.trim(),
      replacement_level: document.getElementById('replacement_level')?.value,
      field: document.getElementById('field')?.value || "general",
      stakeholders,
      lens: { ethics_psych:3, economic:3, social:3, political:3 },
      enable_images: document.getElementById('enable_images')?.checked || false
    };

    if(!payload.job_title){
      if(msg) msg.textContent = "Please enter a job title.";
      return;
    }

    if(genBtn) genBtn.disabled = true;
    showOverlay();
    startFakeProgress();

    try{
      const res = await fetch('/api/generate_scenario', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));

      if(!res.ok){
        stopFakeProgress();
        hideOverlay();
        if(genBtn) genBtn.disabled = false;
        if(msg) msg.textContent = data.message || "Failed to generate scenario.";
        return;
      }

      stopFakeProgress();
      setOverlayStep(5);
      if(overlayTitle) overlayTitle.textContent = "Scenario ready";
      if(overlayMsg) overlayMsg.textContent = "Redirecting to the simulation…";

      setTimeout(() => {
        window.location.href = data.redirect || "/sim";
      }, 450);

    }catch(err){
      stopFakeProgress();
      hideOverlay();
      if(genBtn) genBtn.disabled = false;
      if(msg) msg.textContent = "Network error.";
    }
  });
</script>
{% endblock %}
