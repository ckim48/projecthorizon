{# templates/scenario_input.html #}
{% extends "base.html" %}

{% block title %}Create Scenario | Project Horizon{% endblock %}

{#
  Do NOT center the whole body (navbar must stay visible).
  We center only the glass card inside content.
#}
{% block body_class %}{% endblock %}

{% block content %}
<div class="container" style="max-width:1100px;">
  <div class="d-flex justify-content-center">
    <div class="glass mt-4">

      <div class="mb-2"
           style="font-family:'JetBrains Mono',monospace;
                  color:var(--cyan);
                  letter-spacing:3px;
                  font-size:.75rem;">
        PROJECT HORIZON
      </div>

      <h1 class="mb-1">Create a Scenario</h1>
      <p class="muted mb-4">
        We’ll generate a 5-step simulation with 3 choices per step.
      </p>

      <form id="genForm">
        <div class="row g-3">

          <div class="col-md-7">
            <label class="form-label">Job being replaced</label>
            <input
              class="form-control"
              id="job_title"
              placeholder="e.g., Taxi driver, Nurse, Teacher, Call center agent"
              required
            >
          </div>

          <div class="col-md-5">
            <label class="form-label">Replacement level</label>
            <select class="form-select" id="replacement_level">
              <option value="assist" selected>AI assists humans</option>
              <option value="partial">Partial replacement</option>
              <option value="full">Full replacement</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label">Region / context</label>
            <input
              class="form-control"
              id="region"
              placeholder="e.g., Seoul / national program / local district"
            >
          </div>

          <!-- ✅ NEW: Field/Subject -->
          <div class="col-md-6">
            <label class="form-label">Field / Subject</label>
            <select class="form-select" id="field">
              <option value="general" selected>General / Society</option>
              <option value="science">Science / Research</option>
              <option value="art">Art / Creative work</option>
              <option value="business">Business / Industry</option>
              <option value="health">Health / Medicine</option>
              <option value="education">Education</option>
              <option value="environment">Environment</option>
              <option value="transport">Transport</option>
              <option value="law">Law / Policy</option>
            </select>
            <div class="muted mt-1" style="font-size:.92rem;">
              This shapes the scenario context (risks, terms, safeguards).
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Stakeholders (optional)</label>

            <div class="d-flex flex-wrap gap-2" id="stakeChips">
              <label class="chip"><input type="checkbox" value="workers"> Workers</label>
              <label class="chip"><input type="checkbox" value="consumers"> Consumers</label>
              <label class="chip"><input type="checkbox" value="students"> Students</label>
              <label class="chip"><input type="checkbox" value="patients"> Patients</label>
              <label class="chip"><input type="checkbox" value="government"> Government</label>
              <label class="chip"><input type="checkbox" value="small_business"> Small business</label>
            </div>
          </div>

          <!-- Visuals toggle -->
          <div class="col-12">
            <label class="form-label">Visuals (optional)</label>

            <div class="d-flex align-items-center gap-3 flex-wrap">
              <label class="switch" aria-label="Enable step images">
                <input type="checkbox" id="enable_images">
                <span class="slider"></span>
              </label>

              <div>
                <div id="imageToggleLabel" style="font-weight:700;">
                  Step images: OFF
                </div>
                <div class="muted mt-1" style="font-size:.92rem;">
                  This does not generate images now. You can generate them one-by-one during the simulation.
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="mt-4">
          <button class="btn btn-tech" id="genBtn" type="submit">
            Generate 5-Step Simulation
          </button>
          <div id="msg" class="muted mt-3" style="min-height:22px;"></div>
        </div>
      </form>

    </div>
  </div>
</div>

<style>
  #stakeChips .chip{
    user-select:none;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:.55rem;
    padding:.55rem .8rem;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.85);
    transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
  }

  #stakeChips .chip input{
    width:16px;
    height:16px;
    margin:0;
    accent-color: var(--cyan);
  }

  #stakeChips .chip.active{
    background: rgba(0, 231, 255, .14);
    border-color: rgba(0, 231, 255, .55);
    box-shadow: 0 0 0 3px rgba(0, 231, 255, .12);
  }

  #stakeChips .chip:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.22);
  }

  /* ---------- Nice Toggle Switch ---------- */
  .switch{
    position: relative;
    display: inline-block;
    width: 56px;
    height: 32px;
    flex: 0 0 auto;
  }

  .switch input{
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider{
    position: absolute;
    inset: 0;
    cursor: pointer;
    border-radius: 999px;
    background: rgba(255,255,255,.14);
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.22),
      0 8px 18px rgba(0,0,0,.22);
    transition: background .22s ease, box-shadow .22s ease;
  }

  .slider::before{
    content: "";
    position: absolute;
    width: 24px;
    height: 24px;
    left: 4px;
    top: 4px;
    border-radius: 50%;
    background: rgba(255,255,255,.95);
    box-shadow:
      0 6px 14px rgba(0,0,0,.28),
      inset 0 0 0 1px rgba(0,0,0,.06);
    transition: transform .22s ease;
  }

  .switch input:checked + .slider{
    background: linear-gradient(135deg, rgba(13,202,240,.95), rgba(0,231,255,.95));
    box-shadow:
      inset 0 0 0 1px rgba(0,231,255,.45),
      0 10px 22px rgba(0,231,255,.12),
      0 8px 18px rgba(0,0,0,.22);
  }

  .switch input:checked + .slider::before{
    transform: translateX(24px);
  }

  .switch input:focus-visible + .slider{
    outline: none;
    box-shadow:
      0 0 0 3px rgba(13,202,240,.22),
      inset 0 0 0 1px rgba(255,255,255,.22),
      0 8px 18px rgba(0,0,0,.22);
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  /* Stakeholder chip toggle */
  document.querySelectorAll('#stakeChips .chip').forEach(chip => {
    const input = chip.querySelector('input');
    const sync = () => chip.classList.toggle('active', input.checked);
    sync();
    input.addEventListener('change', sync);
  });

  /* Visuals toggle label */
  const imgToggle = document.getElementById('enable_images');
  const imgLabel  = document.getElementById('imageToggleLabel');

  function syncImageLabel(){
    if(!imgToggle || !imgLabel) return;
    imgLabel.textContent = imgToggle.checked ? "Step images: ON" : "Step images: OFF";
  }
  syncImageLabel();
  imgToggle?.addEventListener('change', syncImageLabel);

  /* Overlay helpers (from base.html) */
  const overlay = document.getElementById('overlay');
  const overlayMsg = document.getElementById('overlayMsg');
  const overlayTitle = document.getElementById('overlayTitle');
  const genBtn = document.getElementById('genBtn');

  function setOverlayStep(n){
    const rows = document.querySelectorAll('#overlaySteps .step-row');
    if(!rows.length) return;

    rows.forEach(row => {
      const step = Number(row.dataset.step);
      const badge = row.querySelector('.badge-mini');

      row.classList.remove('active','done');

      if(step < n){
        row.classList.add('done');
        if(badge) badge.textContent = "Done";
      }else if(step === n){
        row.classList.add('active');
        if(badge) badge.textContent = "In progress";
      }else{
        if(badge) badge.textContent = "Queued";
      }
    });
  }

  function showOverlay(){
    if(!overlay) return;
    overlay.classList.add('show');
    if(overlayTitle) overlayTitle.textContent = "Generating your 5-step simulation…";
    if(overlayMsg) overlayMsg.textContent = "Building scenarios and options.";
    setOverlayStep(1);
  }

  function hideOverlay(){
    if(!overlay) return;
    overlay.classList.remove('show');
  }

  /* Fake progress animation */
  let timer = null;

  function startFakeProgress(){
    let step = 1;
    timer = setInterval(() => {
      step = Math.min(5, step + 1);
      setOverlayStep(step);
      if(overlayMsg){
        overlayMsg.textContent =
          step < 5
            ? `Refining step ${step} and generating choices.`
            : "Finishing and saving to your session.";
      }
      if(step === 5){
        clearInterval(timer);
        timer = null;
      }
    }, 550);
  }

  function stopFakeProgress(){
    if(timer){
      clearInterval(timer);
      timer = null;
    }
  }

  /* Form submit */
  document.getElementById('genForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const msg = document.getElementById('msg');
    msg.textContent = "";

    const stakeholders = Array.from(
      document.querySelectorAll('#stakeChips input:checked')
    ).map(x => x.value);

    const payload = {
      job_title: document.getElementById('job_title').value.trim(),
      region: document.getElementById('region').value.trim(),
      replacement_level: document.getElementById('replacement_level').value,
      field: document.getElementById('field')?.value || "general", // ✅ NEW
      stakeholders,
      lens: { ethics_psych:3, economic:3, social:3, political:3 },
      enable_images: document.getElementById('enable_images')?.checked || false
    };

    genBtn.disabled = true;
    showOverlay();
    startFakeProgress();

    try{
      const res = await fetch('/api/generate_scenario', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if(!res.ok){
        stopFakeProgress();
        hideOverlay();
        genBtn.disabled = false;
        msg.textContent = data.message || "Failed to generate scenario.";
        return;
      }

      stopFakeProgress();
      setOverlayStep(5);
      if(overlayTitle) overlayTitle.textContent = "Scenario ready";
      if(overlayMsg) overlayMsg.textContent = "Redirecting to the simulation…";

      setTimeout(() => {
        window.location.href = data.redirect || "/sim";
      }, 450);

    }catch(err){
      stopFakeProgress();
      hideOverlay();
      genBtn.disabled = false;
      msg.textContent = "Network error.";
    }
  });
</script>
{% endblock %}
