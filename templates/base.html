<!-- templates/base.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Project Horizon{% endblock %}</title>
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

  <!-- Bootstrap + Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#020204;
      --cyan:#0dcaf0;
      --edge:rgba(255,255,255,.10);
      --glass:rgba(255,255,255,.03);
      --muted:rgba(255,255,255,.72);
    }

    html,body{height:100%;}
    body{
      background:radial-gradient(circle at center,#0a1128 0%,#020204 100%);
      color:#fff;
      font-family:Inter,system-ui,sans-serif;
      min-height:100vh;
      margin:0;
    }

    /* Navbar */
    .ph-nav{
      position:sticky; top:0; z-index:1000;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(2,2,4,.55);
      backdrop-filter:blur(14px);
    }
    .ph-brand{
      font-family:"JetBrains Mono",monospace;
      letter-spacing:3px;
      color:var(--cyan)!important;
      font-size:.78rem;
      text-transform:uppercase;
      text-decoration:none;
    }
    .ph-link{
      color:rgba(255,255,255,.86)!important;
      text-decoration:none;
      padding:.55rem .8rem;
      border-radius:10px;
      transition:.2s ease;
      font-family:Inter,system-ui,sans-serif;
      font-weight:600;
      font-size:.95rem;
    }
    .ph-link:hover{
      background:rgba(13,202,240,.08);
      color:#fff!important;
    }

    /* Profile pill */
    .profile-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      text-decoration:none;
      color:rgba(255,255,255,.90)!important;
      transition:.2s ease;
      max-width: 260px;
    }
    .profile-pill:hover{
      border-color:rgba(13,202,240,.40);
      background:rgba(13,202,240,.08);
      color:#fff!important;
    }
    .profile-avatar{
      width:28px; height:28px;
      border-radius:50%;
      background:rgba(13,202,240,.12);
      border:1px solid rgba(13,202,240,.22);
      display:flex; align-items:center; justify-content:center;
      font-family:"JetBrains Mono",monospace;
      font-size:.8rem;
      color:rgba(13,202,240,.95);
      flex:0 0 auto;
    }
    .profile-meta{ min-width:0; line-height:1.05; }
    .profile-name{
      font-weight:700;
      font-size:.90rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .profile-sub{
      font-family:"JetBrains Mono",monospace;
      font-size:.68rem;
      letter-spacing:1.6px;
      text-transform:uppercase;
      color:rgba(255,255,255,.60);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Layout */
    .page-wrap{ padding:26px 16px 60px; }

    .glass{
      width:min(820px,100%);
      border:1px solid var(--edge);
      background:var(--glass);
      backdrop-filter:blur(14px);
      border-radius:18px;
      box-shadow:0 0 80px rgba(13,202,240,.07);
      padding:28px;
    }

    h1{ font-family:"Space Grotesk",sans-serif; font-weight:700; }

    label{
      font-family:"JetBrains Mono",monospace;
      font-size:.72rem;
      letter-spacing:1.8px;
      color:rgba(255,255,255,.74);
      text-transform:uppercase;
    }

    .form-control,.form-select{
      background:rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      border-radius:12px;
      padding:12px 14px;
    }
    .form-control::placeholder{ color:rgba(255,255,255,.58)!important; opacity:1!important; }

    .btn-tech{
      background:transparent;
      border:1px solid var(--cyan);
      color:var(--cyan);
      padding:12px 18px;
      font-family:"JetBrains Mono",monospace;
      border-radius:12px;
      transition:.25s ease;
      width:100%;
    }
    .btn-tech:hover{ background:var(--cyan); color:#000; box-shadow:0 0 25px rgba(13,202,240,.35); }
    .btn-tech:disabled{ opacity:.6; cursor:not-allowed; }

    .muted{ color:var(--muted); }

    /* ===== Loading Overlay ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(2,2,4,.78);
      backdrop-filter:blur(14px);
      display:none;
      z-index:9999;
    }
    .overlay.show{ display:flex; align-items:center; justify-content:center; }
    .overlay-card{
      width:min(560px,92vw);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:18px;
      box-shadow:0 0 90px rgba(13,202,240,.10);
      padding:22px 20px;
    }
    .kicker{
      font-family:"JetBrains Mono",monospace;
      letter-spacing:3px;
      font-size:.75rem;
      color:var(--cyan);
      text-transform:uppercase;
    }
    .overlay-title{
      font-family:"Space Grotesk",sans-serif;
      font-weight:700;
      font-size:1.35rem;
      margin:8px 0 10px;
    }
    .spinner{
      width:44px; height:44px;
      border-radius:50%;
      border:3px solid rgba(255,255,255,.16);
      border-top-color:rgba(13,202,240,.95);
      animation:spin .9s linear infinite;
      flex:0 0 auto;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .progress-line{ height:1px; background:rgba(255,255,255,.10); margin:14px 0; }
    .steps{ display:grid; gap:10px; margin-top:12px; }
    .step-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
    }
    .step-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:rgba(255,255,255,.25);
      box-shadow:0 0 0 6px rgba(255,255,255,.03);
    }
    .step-row.active .dot{
      background:rgba(13,202,240,.95);
      box-shadow:0 0 0 6px rgba(13,202,240,.10);
    }
    .step-row.done{
      border-color:rgba(13,202,240,.22);
      background:rgba(13,202,240,.05);
    }
    .step-row.done .dot{
      background:rgba(13,202,240,.95);
      box-shadow:0 0 0 6px rgba(13,202,240,.08);
    }
    .step-label{
      font-family:"JetBrains Mono",monospace;
      letter-spacing:2px;
      font-size:.72rem;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
      white-space:nowrap;
    }
    .step-text{
      color:rgba(255,255,255,.78);
      font-size:.95rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge-mini{
      font-family:"JetBrains Mono",monospace;
      letter-spacing:2px;
      font-size:.68rem;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      color:rgba(255,255,255,.72);
      white-space:nowrap;
    }
    .step-row.active .badge-mini{
      border-color:rgba(13,202,240,.35);
      background:rgba(13,202,240,.08);
      color:rgba(13,202,240,.95);
    }
    .step-row.done .badge-mini{
      border-color:rgba(13,202,240,.35);
      background:rgba(13,202,240,.10);
      color:rgba(13,202,240,.95);
    }

    {% block head_css %}{% endblock %}
  </style>

  {% block head %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

  {% block navbar %}
  <nav class="navbar navbar-expand-lg ph-nav">
    <div class="container" style="max-width:1100px;">
      <a class="ph-brand" href="/">PROJECT HORIZON</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#phNav"
              aria-controls="phNav" aria-expanded="false" aria-label="Toggle navigation"
              style="border:1px solid rgba(255,255,255,.18);">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="phNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="ph-link nav-link" href="/">Home</a></li>

          {% if session.get("user_id") %}
            <li class="nav-item"><a class="ph-link nav-link" href="/library">Library</a></li>
                    <li class="nav-item"><a class="ph-link nav-link" href="/scenario">Create</a></li>
          <li class="nav-item"><a class="ph-link nav-link" href="/sim">Simulation</a></li>

            <li class="nav-item ms-lg-2">
              <a class="profile-pill" href="/profile">
                <span class="profile-avatar">
                  {{ (session.get("user_name","U")[:1]).upper() }}
                </span>
                <span class="profile-meta">
                  <span class="profile-name">{{ session.get("user_name") }}</span>
                  <span class="profile-sub">Profile</span>
                </span>
              </a>
            </li>
            <li class="nav-item ms-lg-2">
              <button class="btn btn-tech" id="btnLogout" type="button" style="width:auto; padding:10px 14px;">
                Logout
              </button>
            </li>
          {% else %}
            <li class="nav-item ms-lg-2">
              <a class="btn btn-tech" href="/login" style="width:auto; padding:10px 14px;">Login</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>
  {% endblock %}

  {% block overlay %}
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="overlay-card">
      <div class="d-flex align-items-center gap-3">
        <div class="spinner" aria-label="Loading"></div>
        <div style="min-width:0;">
          <div class="kicker">PROJECT HORIZON</div>
          <div class="overlay-title" id="overlayTitle">Workingâ€¦</div>
          <div class="muted" id="overlayMsg">Please wait.</div>
        </div>
      </div>

      <div class="progress-line"></div>

      <div class="steps" id="overlaySteps">
        <div class="step-row active" data-step="1">
          <div class="step-left">
            <div class="dot"></div>
            <div style="min-width:0;">
              <div class="step-label">Step 1</div>
              <div class="step-text">Starting</div>
            </div>
          </div>
          <span class="badge-mini">In progress</span>
        </div>

        <div class="step-row" data-step="2">
          <div class="step-left">
            <div class="dot"></div>
            <div style="min-width:0;">
              <div class="step-label">Step 2</div>
              <div class="step-text">Processing</div>
            </div>
          </div>
          <span class="badge-mini">Queued</span>
        </div>

        <div class="step-row" data-step="3">
          <div class="step-left">
            <div class="dot"></div>
            <div style="min-width:0;">
              <div class="step-label">Step 3</div>
              <div class="step-text">Refining</div>
            </div>
          </div>
          <span class="badge-mini">Queued</span>
        </div>

        <div class="step-row" data-step="4">
          <div class="step-left">
            <div class="dot"></div>
            <div style="min-width:0;">
              <div class="step-label">Step 4</div>
              <div class="step-text">Finalizing</div>
            </div>
          </div>
          <span class="badge-mini">Queued</span>
        </div>

        <div class="step-row" data-step="5">
          <div class="step-left">
            <div class="dot"></div>
            <div style="min-width:0;">
              <div class="step-label">Step 5</div>
              <div class="step-text">Redirecting</div>
            </div>
          </div>
          <span class="badge-mini">Queued</span>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}

  <div class="page-wrap">
    {% block content %}{% endblock %}
  </div>

  <!-- Bootstrap JS (required for navbar collapse) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function(){
      const btn = document.getElementById("btnLogout");
      if (!btn) return;
      btn.addEventListener("click", async () => {
        try{
          const r = await fetch("/logout", { method: "POST", headers: {"Content-Type":"application/json"}, body: "{}" });
          const j = await r.json().catch(()=>null);
          if (j && j.status === "success" && j.redirect) {
            window.location.href = j.redirect;
          } else {
            window.location.href = "/";
          }
        } catch(e){
          window.location.href = "/";
        }
      });
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
