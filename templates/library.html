{% extends "base.html" %}
{% block title %}Library | Project Horizon{% endblock %}

{% block content %}
<div class="container" style="max-width:1200px;">
  <div class="py-4">
    <div class="d-flex align-items-end justify-content-between gap-3 flex-wrap">
      <div>
        <div class="kicker">Shared scenarios</div>
        <h2 class="mb-0" style="font-family:'Space Grotesk',sans-serif; font-weight:800;">Library</h2>
        <div class="muted mt-2" style="max-width:820px;">
          Browse scenarios generated by users. Each card uses a saved cover image.
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-tech-top" href="/scenario">Start a new scenario</a>
      </div>
    </div>

    <hr class="hr-soft"/>

    <div class="row g-3" id="grid"></div>

    <div class="muted mt-4" id="empty" style="display:none;">
      No shared scenarios yet.
    </div>
  </div>
</div>

<!-- Floating Remove All button (admin/moderator only) -->
<div id="removeAllWrap" style="display:none; position:fixed; right:22px; bottom:22px; z-index:9999;">
  <button id="removeAllBtn" class="btn-danger-soft" type="button" style="box-shadow:0 18px 40px rgba(0,0,0,.35);">
    Remove all
  </button>
</div>

<style>
  :root{
    --cyan:#0dcaf0;
    --muted:rgba(255,255,255,.72);
    --danger:#ef4444;
    --danger-bg: rgba(239,68,68,.10);
    --danger-bd: rgba(239,68,68,.30);
  }
  .kicker{
    font-family:"JetBrains Mono",monospace;
    letter-spacing:3px;
    font-size:.75rem;
    color:var(--cyan);
    text-transform:uppercase;
  }
  .muted{ color:var(--muted); }
  .hr-soft{ height:1px; background:rgba(255,255,255,.08); border:0; margin:18px 0; }

  .card-scen{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.02);
    overflow:hidden;
    transition: .18s ease;
  }
  .card-scen:hover{
    transform: translateY(-2px);
    border-color: rgba(13,202,240,.45);
    background: rgba(13,202,240,.06);
  }

  .thumb{
    position:relative;
    width:100%;
    aspect-ratio: 16 / 10;
    overflow:hidden;
    border-bottom:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.25);
  }
  .thumb img{
    width:100%;
    height:100%;
    object-fit: cover;
    display:block;
  }

  .meta{ padding:14px 14px 16px; }
  .title{
    font-family:'Space Grotesk',sans-serif;
    font-weight:800;
    letter-spacing:.2px;
    margin:0 0 6px;
    font-size:1.05rem;
  }
  .sub{
    font-family:"JetBrains Mono",monospace;
    letter-spacing:1px;
    font-size:.74rem;
    text-transform:uppercase;
    color: rgba(255,255,255,.55);
  }

  /* ---------- MATCHED ACTION BUTTONS (single source of truth) ---------- */
  .actions{
    margin-top:12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* base: ALL sizing/layout lives here */
  .btn-action{
    border-radius:12px;
    padding:10px 14px;
    min-height:44px;
    min-width:140px;

    font-weight:800;
    letter-spacing:.2px;

    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;

    text-decoration:none;
    user-select:none;
    -webkit-tap-highlight-color: transparent;

    transition:
      transform .12s ease,
      background .18s ease,
      border-color .18s ease,
      box-shadow .18s ease;
  }
  .btn-action:active{ transform: translateY(1px); }

  /* Play (neutral glass) — VISUAL ONLY */
  .btn-play{
    width: 100%;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.18);
    color:#fff;
    box-shadow: 0 10px 26px rgba(0,0,0,.18);
  }
  .btn-play:hover{
    background: rgba(255,255,255,.10);
    border-color: rgba(255,255,255,.28);
    box-shadow: 0 14px 34px rgba(0,0,0,.22);
  }

  /* Visuals (cyan accent) — VISUAL ONLY */
  .btn-tech{
    background: linear-gradient(135deg, rgba(13,202,240,.22), rgba(13,202,240,.08));
    border:1px solid rgba(13,202,240,.40);
    color:#fff;
    box-shadow: 0 10px 26px rgba(0,0,0,.18);
  }
  .btn-tech:hover{
    border-color: rgba(13,202,240,.65);
    background: rgba(13,202,240,.14);
    color:white;
    box-shadow: 0 14px 34px rgba(0,0,0,.22);
  }

  /* top "Start a new scenario" keeps same brand but bootstrap-like sizing */
  .btn-tech-top{
    background: linear-gradient(135deg, rgba(13,202,240,.22), rgba(13,202,240,.08));
    border:1px solid rgba(13,202,240,.40);
    color:#fff;
    border-radius:12px;
    padding:10px 12px;
    font-weight:800;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .btn-tech-top:hover{
    border-color: rgba(13,202,240,.65);
    background: rgba(13,202,240,.14);
  }

  /* Admin controls */
  .btn-danger-soft{
    border-radius:12px;
    padding:10px 12px;
    min-height:44px;
    border:1px solid var(--danger-bd);
    background: var(--danger-bg);
    color:#fff;
    font-weight:800;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition: .18s ease;
  }
  .btn-danger-soft:hover{
    border-color: rgba(239,68,68,.55);
    background: rgba(239,68,68,.16);
  }

  .admin-row{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .badge-admin{
    font-family:"JetBrains Mono",monospace;
    letter-spacing:1px;
    font-size:.70rem;
    text-transform:uppercase;
    color: rgba(255,255,255,.60);
  }
</style>

<script>
  const byId = (id)=>document.getElementById(id);

  // robust admin flag (Jinja renders 0/1)
  const IS_ADMIN = {{ 1 if (session.get('role') == 'admin') else 0 }};
  const IS_MODERATOR = {{ 1 if (session.get('is_moderator') == 1) else 0 }};
  const USER_ID = {{ session.get('user_id') or 'null' }};

  // Simple inline placeholder (SVG data-uri) if cover_url missing.
  function fallbackCoverDataUri(title, subtitle){
    const t = (title || "Project Horizon").toString().slice(0, 72).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const s = (subtitle || "Scenario cover").toString().slice(0, 110).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="640">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#0b0f17"/>
      <stop offset="1" stop-color="#111a2a"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <rect x="48" y="48" width="928" height="544" rx="26" fill="rgba(255,255,255,0.05)" stroke="rgba(13,202,240,0.35)"/>
  <text x="88" y="168" fill="rgba(13,202,240,0.95)" font-family="monospace" font-size="34" letter-spacing="6">PROJECT HORIZON</text>
  <text x="88" y="260" fill="rgba(255,255,255,0.92)" font-family="system-ui, -apple-system, Segoe UI, Roboto" font-size="54" font-weight="700">${t}</text>
  <text x="88" y="330" fill="rgba(255,255,255,0.70)" font-family="system-ui, -apple-system, Segoe UI, Roboto" font-size="28">${s}</text>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function fmtDate(iso){
    if(!iso) return "";
    return String(iso).slice(0,10);
  }

  async function removeScenario(scenarioId, btn){
    const canRemove = IS_ADMIN || (btn && btn.dataset && btn.dataset.canRemove === "1");
    if(!canRemove) return;
    if(!confirm("Remove this scenario from the library?")) return;

    try{
      if(btn){ btn.disabled = true; btn.textContent = "Removing..."; }

      const res = await fetch(`/admin/scenario/${scenarioId}/remove`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if(!res.ok){
        let msg = "Failed to remove scenario.";
        try{
          const j = await res.json();
          if(j && j.error) msg = j.error;
        }catch(_e){}
        alert(msg);
        if(btn){ btn.disabled = false; btn.textContent = "Remove"; }
        return;
      }

      const cardEl = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
      if(cardEl) cardEl.remove();

      const grid = byId('grid');
      if(grid && grid.children.length === 0){
        byId('empty').style.display = 'block';
      }
    }catch(e){
      alert("Failed to remove scenario.");
      if(btn){ btn.disabled = false; btn.textContent = "Remove"; }
    }
  }

  async function removeAll(){
    if(!(IS_ADMIN || IS_MODERATOR)) return;
    const msg = "Remove ALL scenarios from the library? This will hide every scenario for everyone (is_public=0).";
    if(!confirm(msg)) return;

    const btn = document.getElementById("removeAllBtn");
    if(btn){ btn.disabled = true; btn.textContent = "Removing..."; }

    try{
      const res = await fetch("/admin/scenario/remove_all", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      if(!res.ok){
        let err = "Failed to remove all.";
        try{ const j = await res.json(); if(j && j.error) err = j.error; }catch(_e){}
        alert(err);
        if(btn){ btn.disabled = false; btn.textContent = "Remove all"; }
        return;
      }
      // Clear grid and show empty state
      const grid = byId("grid");
      if(grid) grid.innerHTML = "";
      const empty = byId("empty");
      if(empty){ empty.style.display = "block"; empty.textContent = "No shared scenarios yet."; }
      const wrap = document.getElementById("removeAllWrap");
      if(wrap) wrap.style.display = "none";
    }catch(e){
      alert("Failed to remove all.");
      if(btn){ btn.disabled = false; btn.textContent = "Remove all"; }
    }
  }

  function card(item){
    const col = document.createElement('div');
    col.className = "col-12 col-sm-6 col-lg-4";
    col.setAttribute("data-scenario-id", item.id);

    const title = item.title || "Untitled Scenario";
    const subtitle = (item.author ? item.author + " · " : "") + fmtDate(item.created_at);

    const cover = (item.cover_url && String(item.cover_url).trim())
      ? item.cover_url
      : fallbackCoverDataUri(title, subtitle);

    const canRemove = (item && item.can_remove) ? true : false;
    const adminControls = canRemove ? `
      <div class="admin-row">
        <div class="badge-admin">${IS_ADMIN ? "Admin" : (IS_MODERATOR ? "Moderator" : "Owner")}</div>
        <button class="btn-danger-soft" type="button" data-can-remove="1" onclick="removeScenario(${item.id}, this)">Remove</button>
      </div>
    ` : ``;

    col.innerHTML = `
      <div class="card-scen">
        <div class="thumb">
          <img src="${cover}" alt="cover"
               onerror="this.onerror=null; this.src=fallbackCoverDataUri(${JSON.stringify(title)}, ${JSON.stringify(subtitle)});">
        </div>
        <div class="meta">
          <div class="sub">${item.author || "Unknown"} · ${fmtDate(item.created_at)}</div>
          <h3 class="title">${title}</h3>

          <div class="actions">
            <a class="btn-action btn-play" href="/scenario/${item.id}/start">Play</a>
            <a class="btn-action btn-tech" href="/scenario/${item.id}/start?images=1">Play with visuals</a>
          </div>

          ${adminControls}
        </div>
      </div>
    `;
    return col;
  }

  async function load(){
    const res = await fetch('/api/library');
    const grid = byId('grid');
    grid.innerHTML = '';
    if(!res.ok){
      byId('empty').style.display = 'block';
      byId('empty').textContent = 'Failed to load library.';
      return;
    }
    const data = await res.json();
    const items = data.items || [];

    if(items.length === 0){
      byId('empty').style.display = 'block';
      return;
    }
    byId('empty').style.display = 'none';

    for(const it of items){
      grid.appendChild(card(it));
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    load();
    const wrap = document.getElementById('removeAllWrap');
    if(wrap && (IS_ADMIN || IS_MODERATOR)) wrap.style.display = 'block';
    const btn = document.getElementById('removeAllBtn');
    if(btn && (IS_ADMIN || IS_MODERATOR)) btn.addEventListener('click', removeAll);
  });
</script>
{% endblock %}
