{% extends "base.html" %}
{% block title %}Library | Project Horizon{% endblock %}

{% block content %}
<div class="container" style="max-width:1200px;">
  <div class="py-4">
    <div class="d-flex align-items-end justify-content-between gap-3 flex-wrap">
      <div>
        <div class="kicker">Shared scenarios</div>
        <h2 class="mb-0" style="font-family:'Space Grotesk',sans-serif; font-weight:800;">Library</h2>
        <div class="muted mt-2" style="max-width:820px;">
          Browse scenarios generated by users. Each card uses a saved cover image.
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-tech-top" href="/scenario">Start a new scenario</a>
      </div>
    </div>

    <hr class="hr-soft"/>

    <div class="row g-3" id="grid"></div>

    <div class="muted mt-4" id="empty" style="display:none;">
      No shared scenarios yet.
    </div>
  </div>
</div>

<div id="removeAllWrap" style="display:none; position:fixed; right:22px; bottom:22px; z-index:9999;">
  <button id="removeAllBtn" class="btn-danger-soft" type="button" style="box-shadow:0 18px 40px rgba(0,0,0,.35);">
    Remove all
  </button>
</div>

<style>
  :root{
    --cyan:#0dcaf0;
    --muted:rgba(255,255,255,.72);
    --danger:#ef4444;
    --danger-bg: rgba(239,68,68,.15);
    --danger-bd: rgba(239,68,68,.40);
  }
  .kicker{
    font-family:"JetBrains Mono",monospace;
    letter-spacing:3px;
    font-size:.75rem;
    color:var(--cyan);
    text-transform:uppercase;
  }
  .muted{ color:var(--muted); }
  .hr-soft{ height:1px; background:rgba(255,255,255,.08); border:0; margin:18px 0; }

  /* CARD BASE */
  .card-scen{
    position: relative;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.02);
    overflow:hidden;
    transition: .18s ease;
    height: 100%;
  }
  .card-scen:hover{
    transform: translateY(-2px);
    border-color: rgba(13,202,240,.45);
    background: rgba(13,202,240,.06);
  }

  /* TOP RIGHT TRASH ICON */
  .admin-actions-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 20;
  }
  .btn-remove-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid var(--danger-bd);
    background: rgba(239, 68, 68, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--danger);
    transition: all 0.2s ease;
    padding: 0;
    cursor: pointer;
  }
  .btn-remove-circle:hover {
    background: var(--danger);
    color: white;
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  }
  .btn-remove-circle svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
  }

  .thumb{
    position:relative;
    width:100%;
    aspect-ratio: 16 / 10;
    overflow:hidden;
    border-bottom:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.25);
  }
  .thumb img{
    width:100%;
    height:100%;
    object-fit: cover;
    display:block;
  }

  .meta{ padding:14px 14px 16px; }
  .title{
    font-family:'Space Grotesk',sans-serif;
    font-weight:800;
    letter-spacing:.2px;
    margin:0 0 6px;
    font-size:1.05rem;
    color: #fff;
  }
  .sub{
    font-family:"JetBrains Mono",monospace;
    letter-spacing:1px;
    font-size:.74rem;
    text-transform:uppercase;
    color: rgba(255,255,255,.55);
  }

  .actions{
    margin-top:12px;
    display:flex;
    gap:10px;
  }

  .btn-action{
    flex: 1;
    border-radius:12px;
    padding:10px;
    min-height:44px;
    font-weight:800;
    font-size: 0.9rem;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    transition: .18s ease;
  }

  .btn-play{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.15);
    color:#fff;
  }
  .btn-play:hover{
    background: rgba(255,255,255,.12);
    border-color: rgba(255,255,255,.30);
    color: #fff;
  }

  .btn-tech{
    background: linear-gradient(135deg, rgba(13,202,240,.20), rgba(13,202,240,.05));
    border: 1px solid rgba(13,202,240,.35);
    color:#fff;
  }
  .btn-tech:hover{
    border-color: rgba(13,202,240,.60);
    background: rgba(13,202,240,.15);
    color:white;
  }

  .btn-tech-top{
    background: linear-gradient(135deg, rgba(13,202,240,.20), rgba(13,202,240,.05));
    border: 1px solid rgba(13,202,240,.35);
    color:#fff;
    border-radius:12px;
    padding:10px 20px;
    font-weight:800;
    text-decoration:none;
  }

  .btn-danger-soft{
    border-radius:12px;
    padding:10px 20px;
    border:1px solid var(--danger-bd);
    background: var(--danger-bg);
    color:#fff;
    font-weight:800;
  }
</style>

<script>
  const byId = (id)=>document.getElementById(id);
  const IS_ADMIN = {{ 1 if (session.get('role') == 'admin') else 0 }};
  const IS_MODERATOR = {{ 1 if (session.get('is_moderator') == 1) else 0 }};

  function fallbackCoverDataUri(title, subtitle){
    const t = (title || "Project Horizon").toString().slice(0, 72).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const s = (subtitle || "Scenario cover").toString().slice(0, 110).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="640"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#0b0f17"/><stop offset="1" stop-color="#111a2a"/></linearGradient></defs><rect width="100%" height="100%" fill="url(#g)"/><rect x="48" y="48" width="928" height="544" rx="26" fill="rgba(255,255,255,0.05)" stroke="rgba(13,202,240,0.35)"/><text x="88" y="168" fill="rgba(13,202,240,0.95)" font-family="monospace" font-size="34" letter-spacing="6">PROJECT HORIZON</text><text x="88" y="260" fill="rgba(255,255,255,0.92)" font-family="system-ui" font-size="54" font-weight="700">${t}</text><text x="88" y="330" fill="rgba(255,255,255,0.70)" font-family="system-ui" font-size="28">${s}</text></svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function fmtDate(iso){ return iso ? String(iso).slice(0,10) : ""; }

  async function removeScenario(scenarioId, btn){
    if(!confirm("Are you sure you want to remove this scenario?")) return;
    try{
      const res = await fetch(`/admin/scenario/${scenarioId}/remove`, { method: "POST" });
      if(res.ok){
        document.querySelector(`[data-scenario-id="${scenarioId}"]`).remove();
        if(byId('grid').children.length === 0) byId('empty').style.display = 'block';
      } else {
        alert("Action failed.");
      }
    }catch(e){ alert("Error connecting to server."); }
  }

  async function removeAll(){
    if(!confirm("Remove ALL scenarios?")) return;
    try{
      const res = await fetch("/admin/scenario/remove_all", { method: "POST" });
      if(res.ok) window.location.reload();
    } catch(e) { alert("Network error."); }
  }

  function card(item){
    const col = document.createElement('div');
    col.className = "col-12 col-sm-6 col-lg-4";
    col.setAttribute("data-scenario-id", item.id);

    const title = item.title || "Untitled";
    const subtitle = (item.author ? item.author + " · " : "") + fmtDate(item.created_at);
    const cover = (item.cover_url && String(item.cover_url).trim()) ? item.cover_url : fallbackCoverDataUri(title, subtitle);

    const removeBtnHtml = item.can_remove ? `
      <div class="admin-actions-overlay">
        <button class="btn-remove-circle" title="Remove Scenario" onclick="removeScenario(${item.id}, this)">
          <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/></svg>
        </button>
      </div>
    ` : '';

    col.innerHTML = `
      <div class="card-scen">
        ${removeBtnHtml}
        <div class="thumb">
          <img src="${cover}" alt="cover" onerror="this.src=fallbackCoverDataUri('${title.replace(/'/g,"\\'")}', '');">
        </div>
        <div class="meta">
          <div class="sub">${item.author || "Unknown"} · ${fmtDate(item.created_at)}</div>
          <h3 class="title text-truncate">${title}</h3>
          <div class="actions">
            <a class="btn-action btn-play" href="/scenario/${item.id}/start">Play</a>
            <a class="btn-action btn-tech" href="/scenario/${item.id}/start?images=1">Visuals</a>
          </div>
        </div>
      </div>
    `;
    return col;
  }

  async function load(){
    const res = await fetch('/api/library');
    if(!res.ok) return;
    const data = await res.json();
    const items = data.items || [];
    const grid = byId('grid');
    grid.innerHTML = '';

    if(items.length === 0) { byId('empty').style.display = 'block'; return; }
    items.forEach(it => grid.appendChild(card(it)));
  }

  document.addEventListener('DOMContentLoaded', () => {
    load();
    if(IS_ADMIN || IS_MODERATOR) byId('removeAllWrap').style.display = 'block';
    byId('removeAllBtn').onclick = removeAll;
  });
</script>
{% endblock %}