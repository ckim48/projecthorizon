{% extends "base.html" %}
{% block title %}Simulation | Project Horizon{% endblock %}

{% block content %}
<style>
  .sticky-side{
  position: sticky;
  top: 18px;
  align-self: start;
}
</style>

<div class="container" style="max-width:1200px;">
  <div class="row g-4 py-4">

    <!-- LEFT: main simulation -->
    <div class="col-lg-8">
      <div class="glass p-4 p-md-5">
        <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
          <div class="me-auto">
            <div class="kicker" id="stepKicker">Loading...</div>
            <h2 class="mb-0" id="headline">Please wait</h2>
          </div>

          <!-- UPDATED STEP PILL -->
          <div class="step-pill-wrap">
            <div class="step-pill" id="stepPill">
              <span class="step-pill__label">STEP</span>
              <span class="step-pill__num" id="stepPillNum">—</span>
              <span class="step-pill__sep"></span>
              <span class="step-pill__tot" id="stepPillTot">5</span>
            </div>
          </div>
        </div>

        <hr class="hr-soft"/>

        <!-- Step image panel -->
        <div class="glass p-3 mb-3" style="border-radius:16px; display:none;" id="imgPanel">
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <div>
              <div class="kicker">Step image</div>
              <div class="muted" id="imgHint" style="min-height:20px;">
                No image yet. Click Generate if you want one.
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-tech" id="genImageBtn" type="button">
                Generate image for this step
              </button>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2 mt-2" id="imgLoading" style="display:none;">
            <div class="muted" id="imgLoadingText">Generating image…</div>
          </div>

          <div class="mt-3" id="imgWrap" style="display:none;">
            <img id="stepImg" alt="Step image"
                 style="width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.10);">
          </div>
        </div>

        <div class="muted" id="scenarioText" style="font-size:1.05rem; line-height:1.6;"></div>

        <!-- Step 1-4 -->
        <div class="mt-4" id="questionWrap" style="display:none;">
          <div class="kicker mb-2">Choose one</div>
          <div id="question" class="mb-3" style="font-size:1.12rem;"></div>

          <div class="d-grid gap-2" id="options"></div>

          <div class="d-flex align-items-center justify-content-between gap-3 mt-3">
            <div class="muted" id="choiceHint" style="min-height:22px;">
              Select an option, then click Submit.
            </div>
            <button class="btn btn-tech" id="submitChoiceBtn" disabled type="button">
              Submit Choice
            </button>
          </div>
        </div>

        <!-- Step 5 -->
        <div class="mt-4" id="finalWrap" style="display:none;">
          <button class="btn btn-tech" id="finalizeBtn" type="button">Generate Final Analysis</button>
          <div class="muted mt-3" id="msg" style="min-height:22px;"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: path + viewpoints + final output -->
    <div class="col-lg-4">
      <div class="glass p-4 p-md-4 sticky-side">
        <div class="kicker mb-2">Your Path</div>
        <div class="muted mb-3" id="title"></div>
        <div id="path" class="d-grid gap-2"></div>

        <hr class="hr-soft"/>

        <!-- MOVED HERE: stakeholder viewpoints -->
        <div class="mb-3" id="viewsWrap" style="display:none;">
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <div class="kicker">Key viewpoints</div>
            <div class="muted" style="font-size:.92rem;">Use these to compare trade-offs before choosing.</div>
          </div>
          <div class="row g-3 mt-1" id="viewsGrid"></div>
          <hr class="hr-soft mt-3 mb-3"/>
        </div>

        <!-- Final Output (kept in DOM so JS never crashes; hidden by default) -->
        <div class="scorebox" id="finalOutBox" style="display:none;">
          <div class="t mb-2">Final Output</div>
          <div id="finalOut" class="muted" style="font-size:1.0rem; line-height:1.55;">
            Complete steps 1–4 to unlock the final analysis.
          </div>
        </div>

        <div class="mt-3" id="mbtiBox" style="display:none !important;">
          <div class="scorebox">
            <div class="t mb-2">Horizon Decision Style</div>
            <div class="muted" id="mbtiText" style="font-size:1.0rem; line-height:1.55;">
              —
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>


<!-- Global Loading Overlay -->
<div id="globalLoading" style="display:none;">
  <div class="gl-backdrop"></div>
  <div class="gl-card">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <div>
      <div class="gl-title" id="glTitle">Working…</div>
      <div class="gl-sub muted" id="glSub">Please wait.</div>
    </div>
  </div>
</div>

<!-- Decision Signal Modal -->
<div class="modal fade" id="signalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modal-glass">
      <div class="modal-header border-0">
        <div>
          <div class="kicker">Decision Reflection</div>
          <h5 class="mb-0" style="font-family:'Space Grotesk',sans-serif; font-weight:800;">Quick check (research)</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body pt-2">
        <div class="muted mb-3" id="modalContext" style="font-size:.98rem; line-height:1.5;">
          Please answer a few quick questions about why you chose this option.
        </div>

        <div class="row g-3">
          <!-- confidence -->
          <div class="col-12">
            <div class="field-card">
              <div class="kicker mb-2">Confidence (1–5)</div>
              <div class="d-flex flex-wrap gap-2" id="confRadios"></div>
              <div class="muted mt-2" style="font-size:.92rem;">How confident are you in this choice?</div>
            </div>
          </div>

          <!-- primary value -->
          <div class="col-md-6">
            <div class="field-card h-100">
              <div class="kicker mb-2">Primary value</div>
              <select class="form-select form-select-dark" id="primaryValue">
                <option value="">Select one…</option>
                <option value="safety">Safety / harm reduction</option>
                <option value="fairness">Fairness / equity</option>
                <option value="privacy">Privacy</option>
                <option value="jobs">Jobs / worker protection</option>
                <option value="legitimacy">Legitimacy / trust</option>
                <option value="cost">Cost control</option>
                <option value="speed">Speed / rollout</option>
                <option value="innovation">Innovation</option>
              </select>
              <div class="muted mt-2" style="font-size:.92rem;">What mattered most in this decision?</div>
            </div>
          </div>

          <!-- sliders -->
          <div class="col-md-6">
            <div class="field-card h-100">
              <div class="kicker mb-2">Preferences (1–5)</div>

              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <div class="muted">Risk tolerance</div>
                  <div class="pill" id="riskVal">3</div>
                </div>
                <input type="range" class="form-range" min="1" max="5" step="1" value="3" id="riskTol">
                <div class="muted" style="font-size:.9rem;">Higher = accept more risk for faster benefits</div>
              </div>

              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <div class="muted">Human oversight</div>
                  <div class="pill" id="overVal">3</div>
                </div>
                <input type="range" class="form-range" min="1" max="5" step="1" value="3" id="oversightPref">
                <div class="muted" style="font-size:.9rem;">Higher = want stronger human review / appeals</div>
              </div>

              <div class="mb-1">
                <div class="d-flex justify-content-between">
                  <div class="muted">Participatory governance</div>
                  <div class="pill" id="govVal">3</div>
                </div>
                <input type="range" class="form-range" min="1" max="5" step="1" value="3" id="govPref">
                <div class="muted" style="font-size:.9rem;">Higher = want boards/public input, not centralized only</div>
              </div>
            </div>
          </div>

          <!-- rationale -->
          <div class="col-12">
            <div class="field-card">
              <div class="kicker mb-2">Optional rationale (1 sentence)</div>
              <textarea class="form-control form-control-dark" id="rationale" rows="2" maxlength="240"
                placeholder="Briefly explain your choice (optional)."></textarea>
              <div class="muted mt-2" style="font-size:.9rem;">
                Keep it short. This helps interpret decision patterns.
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="muted" id="signalErr" style="min-height:18px; color:rgba(255,120,120,.9);"></div>
          </div>
        </div>

      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-tech" id="signalSubmitBtn">Submit & Continue</button>
      </div>
    </div>
  </div>
</div>

<style>
  :root{
    --cyan:#0dcaf0;
    --muted:rgba(255,255,255,.72);
    --panel: rgba(255,255,255,.03);
  }
  .kicker{ font-family:"JetBrains Mono",monospace; letter-spacing:3px; font-size:.75rem; color:var(--cyan); text-transform:uppercase; }
  .muted{ color:var(--muted); }
  .pill{ font-family:"JetBrains Mono",monospace; font-size:.72rem; letter-spacing:2px; text-transform:uppercase; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.02); color:rgba(255,255,255,.78); }
  .hr-soft{ height:1px; background:rgba(255,255,255,.08); border:0; margin:18px 0; }

  .step-pill-wrap{ display:flex; justify-content:flex-end; }
  .step-pill{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(13,202,240,.28);
    background:
      radial-gradient(circle at 20% 20%, rgba(13,202,240,.16), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    box-shadow:
      0 10px 30px rgba(0,0,0,.30),
      inset 0 0 0 1px rgba(255,255,255,.06);
    position:relative;
    overflow:hidden;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  .step-pill::before{
    content:"";
    position:absolute;
    inset:-2px;
    background: linear-gradient(90deg, rgba(13,202,240,.0), rgba(13,202,240,.22), rgba(13,202,240,.0));
    transform: translateX(-60%);
    filter: blur(0px);
    opacity:.7;
    pointer-events:none;
  }
  .step-pill:hover::before{
    transform: translateX(60%);
    transition: transform .7s ease;
  }
  .step-pill__label{
    font-family:"JetBrains Mono",monospace;
    font-size:.72rem;
    letter-spacing:2.5px;
    text-transform:uppercase;
    color: rgba(13,202,240,.95);
    padding-left:2px;
  }
  .step-pill__num{
    font-family:'Space Grotesk',sans-serif;
    font-weight:900;
    font-size:1.05rem;
    line-height:1;
    color:#fff;
    text-shadow: 0 6px 16px rgba(0,0,0,.35);
  }
  .step-pill__sep{
    width:1px;
    height:18px;
    background: rgba(255,255,255,.14);
  }
  .step-pill__tot{
    font-family:"JetBrains Mono",monospace;
    font-size:.85rem;
    letter-spacing:1px;
    color: rgba(255,255,255,.70);
  }

  .btn-choice{
    text-align:left;
    width:100%;
    padding:14px 14px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.02);
    color:#fff;
    transition:.2s ease;
  }
  .btn-choice:hover{
    border-color:rgba(13,202,240,.45);
    background:rgba(13,202,240,.06);
  }
  .btn-choice.selected{
    border-color: rgba(13,202,240,.85);
    background: rgba(13,202,240,.10);
    box-shadow: 0 0 0 3px rgba(13,202,240,.14);
  }

  .scorebox{
    border:1px solid rgba(13,202,240,.22);
    background:radial-gradient(circle at top, rgba(13,202,240,.10), transparent 60%), rgba(255,255,255,.02);
    border-radius:16px;
    padding:16px;
  }
  .scorebox .t{ font-family:"JetBrains Mono",monospace; font-size:.72rem; letter-spacing:2px; color:var(--cyan); text-transform:uppercase; }
  .list-clean{ margin:0; padding-left:18px; }

  .view-card{
    border:1px solid rgba(255,255,255,.10);
    background: var(--panel);
    border-radius:16px;
    padding:14px 14px 12px;
    height:100%;
    transition:.2s ease;
  }
  .view-card:hover{
    border-color: rgba(13,202,240,.35);
    background: rgba(13,202,240,.04);
  }
  .view-title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .badge-mini{
    font-family:"JetBrains Mono",monospace;
    font-size:.70rem;
    letter-spacing:1.5px;
    text-transform:uppercase;
    padding:5px 8px;
    border-radius:999px;
    border:1px solid rgba(13,202,240,.25);
    color: rgba(13,202,240,.95);
    background: rgba(13,202,240,.06);
    white-space:nowrap;
  }
  .view-list{
    margin:0;
    padding-left:18px;
    color: rgba(255,255,255,.76);
  }
  .view-list li{ margin:6px 0; }

  .modal-glass{
    background: rgba(10,12,18,.92);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 18px;
    box-shadow: 0 30px 80px rgba(0,0,0,.45);
  }
  .field-card{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    border-radius: 16px;
    padding: 14px;
  }
  .form-select-dark, .form-control-dark{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    color: rgba(255,255,255,.92);
    border-radius: 12px;
  }
  .form-select-dark:focus, .form-control-dark:focus{
    outline: none;
    box-shadow: 0 0 0 3px rgba(13,202,240,.16);
    border-color: rgba(13,202,240,.45);
  }

  .conf-btn{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    color: rgba(255,255,255,.88);
    border-radius: 999px;
    padding: 8px 12px;
    font-family: "JetBrains Mono", monospace;
    font-size: .85rem;
    letter-spacing: 1px;
    transition: .15s ease;
  }
  .conf-btn:hover{ border-color: rgba(13,202,240,.35); background: rgba(13,202,240,.05); }
  .conf-btn.active{ border-color: rgba(13,202,240,.85); background: rgba(13,202,240,.10); }

  #globalLoading{ position:fixed; inset:0; z-index:2000; }
  #globalLoading .gl-backdrop{
    position:absolute; inset:0;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
  }
  #globalLoading .gl-card{
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%);
    width:min(420px, calc(100vw - 32px));
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(10,12,18,.92);
    box-shadow: 0 30px 80px rgba(0,0,0,.55);
    padding:18px 18px 16px;
    display:flex; align-items:center; gap:14px;
  }
  #globalLoading .gl-title{
    font-family:'Space Grotesk',sans-serif;
    font-weight:800;
    color:#fff;
    line-height:1.2;
  }
  #globalLoading .gl-sub{ font-size:.95rem; }
</style>
{% endblock %}

{% block scripts %}
<script>
  let SCENARIO = null;
  let PROGRESS = null;

  let SELECTED_OPTION_ID = null;
  let PENDING_OPTION_ID = null;

  let IMAGES_LOADING = false;

  // decision timer
  let STEP_START_MS = null;

  const byId = (id)=>document.getElementById(id);
  const safeArr = (x)=>Array.isArray(x) ? x : [];

  // Safe setters to prevent "Cannot set properties of null"
  function setText(id, text){
    const el = byId(id);
    if(el) el.textContent = (text ?? "");
  }
  function setHTML(id, html){
    const el = byId(id);
    if(el) el.innerHTML = (html ?? "");
  }
  function setDisplay(id, display){
    const el = byId(id);
    if(el) el.style.display = display;
  }

  // -------------------------
  // Global loading overlay
  // -------------------------
  function setGlobalLoading(on, title, sub){
    const el = byId('globalLoading');
    if(!el) return;
    el.style.display = on ? "block" : "none";
    if(title) setText('glTitle', title);
    if(sub) setText('glSub', sub);
  }

  function currentStep(){
    return Number(PROGRESS?.current_step || 1);
  }

  function clearChoiceSelection(){
    SELECTED_OPTION_ID = null;
    const submitBtn = byId('submitChoiceBtn');
    if(submitBtn) submitBtn.disabled = true;

    setText('choiceHint', "Select an option, then click Submit.");

    document.querySelectorAll('#options .btn-choice').forEach(b=>b.classList.remove('selected'));
  }

  function selectChoice(optionId, btnEl){
    SELECTED_OPTION_ID = optionId;
    document.querySelectorAll('#options .btn-choice').forEach(b=>b.classList.remove('selected'));
    btnEl.classList.add('selected');

    const submitBtn = byId('submitChoiceBtn');
    if(submitBtn) submitBtn.disabled = false;

    setText('choiceHint', `Selected: ${optionId}. Click Submit to continue.`);
  }

  // -------------------------
  // Images (spinner fix)
  // -------------------------
  function hideStepImage(){
    const wrap = byId('imgWrap');
    const img = byId('stepImg');

    IMAGES_LOADING = false;
    setDisplay('imgLoading', "none");
    setText('imgLoadingText', "");

    if(wrap) wrap.style.display = "none";
    if(img) img.src = "";
  }

  function showStepImage(url){
    const loadingRow = byId('imgLoading');
    const loadingText = byId('imgLoadingText');
    const hint = byId('imgHint');
    const wrap = byId('imgWrap');
    const img = byId('stepImg');

    if(!url){
      hideStepImage();
      if(hint) hint.textContent = "No image yet. Click Generate if you want one.";
      return;
    }

    IMAGES_LOADING = false;
    if(loadingRow) loadingRow.style.display = "none";
    if(loadingText) loadingText.textContent = "";
    if(hint) hint.textContent = "Image shown for this step.";

    if(img){
      img.onload = () => {
        IMAGES_LOADING = false;
        if(loadingRow) loadingRow.style.display = "none";
        if(loadingText) loadingText.textContent = "";
      };
      img.onerror = () => {
        IMAGES_LOADING = false;
        if(loadingRow) loadingRow.style.display = "none";
        if(loadingText) loadingText.textContent = "";
        if(hint) hint.textContent = "Image failed to load.";
      };
      img.src = url;
    }
    if(wrap) wrap.style.display = "block";
  }

  function setImgLoading(on, text){
    IMAGES_LOADING = !!on;

    const row = byId('imgLoading');
    if(row) row.style.display = on ? "flex" : "none";

    if(on){
      if(text) setText('imgLoadingText', text);
    }else{
      setText('imgLoadingText', "");
    }

    const btn = byId('genImageBtn');
    if(!btn) return;

    btn.disabled = !!on;

    if(on){
      btn.dataset.prevText = btn.textContent || "";
      btn.textContent = "Generating…";
      btn.setAttribute("aria-busy", "true");
    }else{
      btn.removeAttribute("aria-busy");
      if(btn.dataset.prevText) btn.textContent = btn.dataset.prevText;
    }
  }

  function syncImagePanelForStep(){
    const panel = byId('imgPanel');
    const step = currentStep();

    if(!panel) return;

    if(!PROGRESS?.images_enabled){
      panel.style.display = "none";
      IMAGES_LOADING = false;
      setDisplay('imgLoading', "none");
      setText('imgLoadingText', "");
      hideStepImage();
      return;
    }

    panel.style.display = "block";

    if(!IMAGES_LOADING){
      setDisplay('imgLoading', "none");
      setText('imgLoadingText', "");
    }

    const btn = byId('genImageBtn');

    const imgs = PROGRESS?.images;
    const imgUrl =
      (Array.isArray(imgs) ? (imgs[step] || imgs[String(step)]) : (imgs?.[String(step)] || imgs?.[step])) || null;

    if(imgUrl){
      IMAGES_LOADING = false;
      setDisplay('imgLoading', "none");
      setText('imgLoadingText', "");

      showStepImage(imgUrl);

      if(btn){
        btn.textContent = `Image ready (step ${Math.min(step,5)})`;
        btn.disabled = true;
      }
      setText('imgHint', "Image shown for this step.");
      return;
    }

    hideStepImage();
    setText('imgHint', "No image yet. Click Generate if you want one.");

    if(btn){
      btn.textContent = `Generate image for step ${Math.min(step,5)}`;
      btn.disabled = !!IMAGES_LOADING;
    }
  }

  async function maybeAutoGenerateImage(){
    const step = currentStep();
    if(!PROGRESS?.images_enabled) return;
    if(IMAGES_LOADING) return;

    const imgs = PROGRESS?.images;
    const existing =
      (Array.isArray(imgs) ? (imgs[step] || imgs[String(step)]) : (imgs?.[String(step)] || imgs?.[step])) || null;
    if(existing) return;

    await generateStepImage(true);
  }

  async function generateStepImage(auto=false){
    const step = currentStep();
    if(!PROGRESS?.images_enabled) return;
    if(IMAGES_LOADING) return;

    const imgs = PROGRESS?.images;
    const existing =
      (Array.isArray(imgs) ? (imgs[step] || imgs[String(step)]) : (imgs?.[String(step)] || imgs?.[step])) || null;

    if(existing){
      IMAGES_LOADING = false;
      setDisplay('imgLoading', "none");
      setText('imgLoadingText', "");
      showStepImage(existing);
      syncImagePanelForStep();
      return;
    }

    setImgLoading(true, `Generating image for step ${Math.min(step,5)}…`);
    if(!auto){
      setGlobalLoading(true, 'Generating image…', 'Creating a visual for this step.');
    }

    try{
      const res = await fetch('/api/step_image', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ step })
      });
      const data = await res.json();

      if(!res.ok){
        setText('imgHint', data.message || "Failed to generate image.");
        return;
      }

      await loadState({ skipAutoImage: true });

    }catch(e){
      setText('imgHint', "Network error.");
    }finally{
      setImgLoading(false);
      syncImagePanelForStep();
      if(!auto) setGlobalLoading(false);
    }
  }

  // -------------------------
  // Views
  // -------------------------
  function renderViews(views){
    const wrap = byId('viewsWrap');
    const grid = byId('viewsGrid');
    if(!wrap || !grid) return;

    grid.innerHTML = "";

    const arr = safeArr(views);
    if(!arr.length){
      wrap.style.display = "none";
      return;
    }

    arr.forEach(v=>{
      const col = document.createElement('div');
      col.className = "col-12";

      const card = document.createElement('div');
      card.className = "view-card";

      const head = document.createElement('div');
      head.className = "view-title";

      const st = document.createElement('div');
      st.style.fontFamily = "'Space Grotesk',sans-serif";
      st.style.fontWeight = "700";
      st.style.fontSize = "1.02rem";
      st.textContent = v.stakeholder || "Stakeholder";

      const badge = document.createElement('div');
      badge.className = "badge-mini";
      badge.textContent = "VIEW";

      head.appendChild(st);
      head.appendChild(badge);

      const ul = document.createElement('ul');
      ul.className = "view-list";

      safeArr(v.bullets).slice(0,4).forEach(b=>{
        const li = document.createElement('li');
        li.textContent = String(b);
        ul.appendChild(li);
      });

      card.appendChild(head);
      card.appendChild(ul);
      col.appendChild(card);
      grid.appendChild(col);
    });

    wrap.style.display = "block";
  }

  // -------------------------
  // Options render
  // -------------------------
  function makeOptionButton(opt){
    const btn = document.createElement('button');
    btn.type = "button";
    btn.className = "btn-choice";

    const row = document.createElement('div');
    row.className = "d-flex justify-content-between align-items-start gap-3";

    const left = document.createElement('div');

    const kicker = document.createElement('div');
    kicker.className = "kicker";
    kicker.textContent = opt.id || "?";

    const label = document.createElement('div');
    label.style.fontFamily = "'Space Grotesk',sans-serif";
    label.style.fontWeight = "700";
    label.style.fontSize = "1.08rem";
    label.textContent = opt.label || "";

    const summary = document.createElement('div');
    summary.className = "muted";
    summary.style.marginTop = "6px";
    summary.textContent = opt.summary || "";

    left.appendChild(kicker);
    left.appendChild(label);
    left.appendChild(summary);

    row.appendChild(left);
    btn.appendChild(row);

    btn.addEventListener('click', ()=>selectChoice(opt.id, btn));
    return btn;
  }

  // -------------------------
  // Horizon MBTI box render (right panel)
  // -------------------------
  function renderMbtiBox(){
    const box = byId('mbtiBox');
    const text = byId('mbtiText');
    const t = PROGRESS?.mbti_type;
    const sc = PROGRESS?.mbti_scores || null;

    if(!box || !text) return;

    if(!t && (!sc || Object.keys(sc).length === 0)){
      box.style.display = "none";
      return;
    }

    const parts = [];
    if(t) parts.push(`<div style="font-family:'Space Grotesk',sans-serif; font-weight:800; font-size:1.05rem;">${t}</div>`);

    if(sc){
      const fmt = (x)=> (typeof x === "number" ? x.toFixed(2) : String(x ?? "0"));
      parts.push(`<div class="muted mt-2"><strong>S/U:</strong> ${fmt(sc.SU)}</div>`);
      parts.push(`<div class="muted"><strong>F/G:</strong> ${fmt(sc.FG)}</div>`);
      parts.push(`<div class="muted"><strong>H/A:</strong> ${fmt(sc.HA)}</div>`);
      parts.push(`<div class="muted"><strong>P/C:</strong> ${fmt(sc.PC)}</div>`);
      parts.push(`<div class="muted mt-2" style="font-size:.92rem;">Computed from your step reflections (confidence, values, and preferences).</div>`);
    }

    text.innerHTML = parts.join("");
    box.style.display = "none";
  }

  // -------------------------
  // Main render
  // -------------------------
  function renderStep(){
    const step = currentStep();
    STEP_START_MS = performance.now();

    setText('title', SCENARIO?.title || "");

    const shownStep = Math.min(step,5);
    setText('stepPillNum', String(shownStep));
    setText('stepPillTot', "5");

    syncImagePanelForStep();

    const steps = safeArr(SCENARIO?.steps);
    if(steps.length < 5){
      setText('stepKicker', "Error");
      setText('headline', "Scenario data is incomplete");
      setText('scenarioText', "Your generated scenario did not include 5 steps. Please regenerate.");
      setDisplay('questionWrap', "none");
      setDisplay('finalWrap', "none");
      setDisplay('viewsWrap', "none");
      return;
    }

    if(step <= 4){
      const s = steps[step-1];

      setText('stepKicker', "Scenario");
      setText('headline', s.headline || "");
      setText('scenarioText', s.scenario || "");

      renderViews(s.views);

      setDisplay('questionWrap', "block");
      setDisplay('finalWrap', "none");

      // Safe: finalOut exists, but box stays hidden unless you enable later
      setText('finalOut', "Complete steps 1–4 to unlock the final analysis.");

      setText('question', s.question || "");

      const optsWrap = byId('options');
      if(optsWrap){
        optsWrap.innerHTML = "";
        clearChoiceSelection();
        safeArr(s.options).forEach(o => optsWrap.appendChild(makeOptionButton(o)));
      }

    }else{
      const s5 = steps[4];
      setText('stepKicker', "Final");
      setText('headline', s5.headline || "Final Analysis");
      setText('scenarioText', s5.final_prompt || "Generate the final impact report.");

      setDisplay('questionWrap', "none");
      setDisplay('finalWrap', "block");
    }
  }

  // -------------------------
  // Modal logic (collect decision signals)
  // -------------------------
  let signalModal = null;
  let selectedConfidence = null;

  function initConfidenceRadios(){
    const wrap = byId('confRadios');
    if(!wrap) return;

    wrap.innerHTML = "";
    selectedConfidence = 3;

    for(let i=1;i<=5;i++){
      const b = document.createElement('button');
      b.type = "button";
      b.className = "conf-btn" + (i===3 ? " active" : "");
      b.textContent = String(i);
      b.addEventListener('click', ()=>{
        selectedConfidence = i;
        wrap.querySelectorAll('.conf-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
      });
      wrap.appendChild(b);
    }
  }

  function resetModalFields(){
    setText('signalErr', "");
    initConfidenceRadios();

    const pv = byId('primaryValue'); if(pv) pv.value = "";
    const rt = byId('riskTol'); if(rt) rt.value = 3;
    const op = byId('oversightPref'); if(op) op.value = 3;
    const gp = byId('govPref'); if(gp) gp.value = 3;

    setText('riskVal', "3");
    setText('overVal', "3");
    setText('govVal', "3");

    const ra = byId('rationale'); if(ra) ra.value = "";
  }

  function openSignalModal(){
    const step = currentStep();
    setText('modalContext', `Step ${step}: you selected option ${PENDING_OPTION_ID}. Please answer a few quick questions about this decision.`);
    resetModalFields();
    if(signalModal) signalModal.show();
  }

  function getDecisionMs(){
    if(typeof STEP_START_MS !== "number") return null;
    const ms = Math.round(performance.now() - STEP_START_MS);
    return ms >= 0 ? ms : null;
  }

  function buildSignalPayload(){
    return {
      confidence: selectedConfidence,
      primary_value: byId('primaryValue')?.value || "",
      risk_tolerance: Number(byId('riskTol')?.value || 3),
      oversight_preference: Number(byId('oversightPref')?.value || 3),
      governance_preference: Number(byId('govPref')?.value || 3),
      rationale: (byId('rationale')?.value || "").trim(),
      decision_ms: getDecisionMs(),
    };
  }

  function validateSignal(sig){
    if(!sig) return "Missing signal.";
    if(!(sig.confidence >= 1 && sig.confidence <= 5)) return "Please select a confidence (1–5).";
    if(!sig.primary_value) return "Please select a primary value.";
    const okPV = ["safety","fairness","cost","speed","privacy","legitimacy","jobs","innovation"].includes(sig.primary_value);
    if(!okPV) return "Primary value is invalid.";
    return null;
  }

  async function submitChoice(){
    if(!SELECTED_OPTION_ID) return;

    if(currentStep() <= 4){
      PENDING_OPTION_ID = SELECTED_OPTION_ID;
      openSignalModal();
      return;
    }
  }

  async function submitSignalAndContinue(){
    const errBox = byId('signalErr');
    if(errBox) errBox.textContent = "";

    const sig = buildSignalPayload();
    const err = validateSignal(sig);
    if(err){
      if(errBox) errBox.textContent = err;
      return;
    }

    const sBtn = byId('signalSubmitBtn');
    if(sBtn){
      sBtn.disabled = true;
      sBtn.textContent = "Saving…";
    }

    try{
      const res = await fetch('/api/choose', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ option: PENDING_OPTION_ID, signal: sig })
      });
      const data = await res.json();

      if(!res.ok){
        if(errBox) errBox.textContent = data.message || "Failed to save decision.";
        return;
      }

      if(signalModal) signalModal.hide();
      setGlobalLoading(true, 'Generating next step…', 'Building the next part of the scenario.');
      await loadState();

    }catch(e){
      if(errBox) errBox.textContent = "Network error.";
    }finally{
      if(sBtn){
        sBtn.disabled = false;
        sBtn.textContent = "Submit & Continue";
      }
    }
  }

  function bindSlider(id, badgeId){
    const el = byId(id);
    const b = byId(badgeId);
    if(!el || !b) return;

    const sync = ()=>{ b.textContent = String(el.value); };
    el.addEventListener('input', sync);
    sync();
  }

  // -------------------------
  // Final
  // -------------------------
  async function finalize(){
    setText('msg', "Generating final analysis...");
    setGlobalLoading(true, "Generating final analysis…", "This may take a moment.");
    try{
      const res = await fetch('/api/finalize', { method:'POST' });
      const data = await res.json();
      if(!res.ok){
        setText('msg', data.message || "Failed.");
        setGlobalLoading(false);
        return;
      }
      setText('msg', "Done.");
      renderFinal(data.final);
      setGlobalLoading(false);
    }catch(e){
      setText('msg', "Network error.");
      setGlobalLoading(false);
    }
  }

  function renderFinal(final){
    // Show the Final Output box and fill it
    const box = byId('finalOutBox');
    if(box) box.style.display = "block";

    const di = final?.dimension_impacts || {};
    const safe = final?.recommended_safeguards || [];

    setHTML('finalOut', `
      <div style="font-family:'Space Grotesk',sans-serif; font-weight:700; font-size:1.05rem;">${final?.verdict_title || "Result"}</div>
      <div class="muted mt-2"><strong>Ethics/Psych:</strong> ${di.ethics_psych?.score_1to10 ?? "-"} / 10</div>
      <div class="muted"><strong>Economic:</strong> ${di.economic?.score_1to10 ?? "-"} / 10</div>
      <div class="muted"><strong>Social:</strong> ${di.social?.score_1to10 ?? "-"} / 10</div>
      <div class="muted"><strong>Political:</strong> ${di.political?.score_1to10 ?? "-"} / 10</div>
      <div class="mt-3 muted"><strong>Safeguards</strong></div>
      <ul class="list-clean muted">
        ${safe.slice(0,6).map(x=>`<li>${String(x)}</li>`).join('')}
      </ul>
    `);
  }

  async function loadState({ skipAutoImage = false } = {}){
    setGlobalLoading(true, 'Loading…', 'Syncing your current step.');
    const res = await fetch('/api/state');
    if(!res.ok){
      setGlobalLoading(false);
      window.location.href = "/scenario";
      return;
    }

    const data = await res.json();
    SCENARIO = data.scenario;
    PROGRESS = data.progress;

    renderStep();

    // Ensure cover exists for library listing
    try{
      await fetch('/api/ensure_cover', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:'{}'
      });
    }catch(e){}

    if(!skipAutoImage){
      try{ await maybeAutoGenerateImage(); }catch(e){}
    }

    setGlobalLoading(false);
  }

  // -------------------------
  // init
  // -------------------------
  byId('finalizeBtn')?.addEventListener('click', finalize);
  byId('submitChoiceBtn')?.addEventListener('click', submitChoice);
  byId('genImageBtn')?.addEventListener('click', ()=>generateStepImage(false));
  byId('signalSubmitBtn')?.addEventListener('click', submitSignalAndContinue);

  document.addEventListener('DOMContentLoaded', ()=>{
    // Bootstrap modal (requires bootstrap JS loaded in base.html)
    signalModal = new bootstrap.Modal(byId('signalModal'), { backdrop: 'static', keyboard: false });

    bindSlider('riskTol', 'riskVal');
    bindSlider('oversightPref', 'overVal');
    bindSlider('govPref', 'govVal');

    initConfidenceRadios();
    loadState();
  });
</script>
{% endblock %}
